---
layout:     post
title:      流处理基本知识
subtitle:   流处理基本知识
date:       2018-10-20
author:     danfeng
header-img: img/post-bg-ios10.jpg
catalog: 	 true
tags:
    - 流处理
    - Flink
---       

## 流式架构的基本概念
  ### 流
  最初流式系统架构是通过微批处理的方式来实现的，如SparkStreaming,其原理是将多个微批处理任务进行串联起来进行数据处理，牺牲了吞吐和延迟,为此，业界便开始构建用于处理没有时间边界的数据（无界数据集，Unbounded Data）的实时数据。因此从这个角度分析，流可以定义为一种无界数据集设计的数据处理引擎，这种引擎具备以下的特征：
-       具备强一致性，支持exactly-once语义
-       提供丰富的时间工具，如事件事件、处理时间、窗口等。
-       保证系统具有可弹性、伸缩性。
-       支持高层语义，如流式SQL、复杂时间CEP.
## 时间
   在流式处理理论中，通常采用事件和记录表示从处理的集合中拉取的数据，在Flink中通常以有结构的对象表示事件。在无界数据集合处理中，主要有两类事件：
-  事件时间：事件实际发生的时间。
-  处理时间：事件被处理的时间。

---

并非所有的场景都关注事件时间，但是其重要性不言而喻，例如在用户行为分析、异常检测、基于信贷历史风控模型中
，事件的起点起到了决定性作用。
-  用户行为特征分析：用户浏览网页产生一系列的页面点击和浏览时长的数据，这些数据被称之为用户行为数据，用户行为数据可以在精准营销，产品迭代等功能环节。
-  异常检测 
-  信贷历史/反欺诈
  

---
### 事件处理时间 和 事件时间偏差原因
-   受共享资源影响 ：如网络延迟、网络分区（CAP理论）、共享cpu等
-   软件架构：如分布式的并发竞争和时钟不一致
-   数据自身特性：如key的特殊分布、吞吐量的快速涨落、乱序等。
### 窗口
将数据集划分成一个个的有限数据区间的机制，也就是在数据集合中增加临时处理边界，用于将事件按照时间或其他特征进行分组分析。
-    滚动窗口(Tumbling window)：按时间划分成固定长度，不重叠且等长的时间窗口。其中time可以是事件时间和处理时间。
-    滑动窗口（sliding window）：有重叠的窗口，按照滑动步长将时间拆分成固定的长度，当滑动步长小于窗口长度的时候，时间窗口会发生重叠。
-    会话窗口：以活动时间间隔作为边界，将一系列连续事件拆分到不同的会话中，会话窗口的长度是动态的。
### 水印（WaterMark）
  水印是嵌入到事件时间轴上，用于判断时间窗口内的所有数据均已经到达引擎的一种时间推理工具，是一种既可以在流处理引擎侧嵌入，又可以在消息系统侧嵌入的时间戳。水印的语义是事件的时间小于水印标记的时间的事件不会再出现，因为水印是事件的推进器。水印可以有效的标记出每个窗格里面有多少个记录点可以被聚合处理，我们不能够确定什么时候触发聚合水印，水印可以标记出这个时间点。水印可以标记出某个时间点以前的所有记录都已经到达引擎，可以被处理。考虑到系统开销，水印是离散的，只有部分记录后面附有水印，为了便于分析，水印通常以连续曲线表示。通常的水印主要分成下面两种水印：
  1. 完美水印表示早于水印标记的时间戳的所有的记录都已经成功的到达，非乱序的无界数据集中最后一条记录的时间就是完美时间水印。完美水印会造成大概率的大延迟，同时会拉长窗口的生存期--也就是这两个窗口所占用的资源都不能及时的进行释放。
  2. 启发式水印：尽可能的确定时间戳的一种估计，可能某些事件晚于水印到达的情况。（不足：统计不够精确，导致某些事件落后于水印，导致没有计算在窗口中，这不满足精准计算的要求，引擎需要提供事处理机制予以校正。）




  
  
 
